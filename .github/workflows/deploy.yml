name: Deploy Kinetis System

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite ejecutarlo manualmente desde la web de GitHub

permissions:
  contents: read
  id-token: write # OBLIGATORIO: Permite pedir el token a Google para la Federaci√≥n

jobs:
  deploy:
    name: Wake, Sync & Build
    runs-on: ubuntu-latest
    
    steps:
      # 1. Bajar el c√≥digo al entorno temporal de GitHub
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Autenticaci√≥n Segura con Google (Workload Identity Federation)
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

      # 3. Preparar herramientas de Google Cloud CLI
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v1'

      # 4. INTELIGENCIA DE COSTOS: Encender la VM si est√° apagada
      - name: Wake up Kinetis Node
        run: |
          echo "üîç Verificando estado de la instancia..."
          # Ajusta la zona si usaste otra diferente a us-central1-a
          STATUS=$(gcloud compute instances describe kinetis-node --zone=us-central1-a --format="value(status)")
          
          if [ "$STATUS" = "TERMINATED" ]; then
            echo "üí§ La instancia est√° durmiendo. Encendiendo para trabajar..."
            gcloud compute instances start kinetis-node --zone=us-central1-a --project=kinetis-security
            echo "‚è≥ Esperando 45 segundos para que el sistema operativo inicie..."
            sleep 45
          else
            echo "‚ö° La instancia ya est√° activa. Procediendo..."
          fi

      # 5. DESPLIEGUE PROFESIONAL v√≠a SSH
      - name: Sync & Build on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Detener el script inmediatamente si alg√∫n comando falla
            set -e
            
            echo "üìÇ Preparando directorio de trabajo..."
            # Nos aseguramos de estar en la carpeta ra√≠z del usuario
            mkdir -p ~/kinetis-ai-guard
            cd ~/kinetis-ai-guard
            
            # L√≥gica Inteligente de Git
            if [ ! -d ".git" ]; then
              echo "üöÄ Clonando repositorio por primera vez..."
              # Reemplaza con tu URL si fuera privada, pero con SSH keys ya configuradas funciona
              git clone https://github.com/marcos1394/kinetis-ai-guard.git .
            else
              echo "üîÑ Actualizando c√≥digo fuente..."
              git pull origin main
            fi
            
            # --- FASE DE COMPILACI√ìN (Monorepo & Sui) ---
            
            echo "üîç Verificando entorno de compilaci√≥n..."
            
            # Buscamos 'sui' en el PATH global (/usr/local/bin)
            if command -v sui &> /dev/null; then
                echo "üõ†Ô∏è  Sui detectado. Iniciando compilaci√≥n de contratos..."
                
                # Entramos a la carpeta espec√≠fica del paquete de contratos (Estructura Monorepo)
                cd packages/contracts/kinetis_core
                
                # Ejecutamos la compilaci√≥n real. Si hay errores de sintaxis en Move, esto fallar√° y te avisar√°.
                sui move build
                
                echo "‚úÖ BUILD EXITOSO: Los contratos son v√°lidos."
            else
                echo "‚ùå ERROR CR√çTICO: El binario 'sui' no se encuentra."
                echo "Aseg√∫rate de haber ejecutado: sudo mv ~/.sui/bin/sui /usr/local/bin/"
                exit 1 # Esto hace que GitHub marque el deploy como FALLIDO (Rojo)
            fi
            
            echo "üéâ Despliegue y Verificaci√≥n completados."