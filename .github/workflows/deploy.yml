name: Deploy Kinetis System

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite ejecutarlo manualmente desde GitHub si quieres

permissions:
  contents: read
  id-token: write # NECESARIO para que Google conf√≠e en GitHub

jobs:
  deploy:
    name: Wake & Deploy
    runs-on: ubuntu-latest
    
    steps:
      # 1. Bajar el c√≥digo al entorno temporal de GitHub
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Autenticaci√≥n Segura con Google (Sin llaves JSON)
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

      # 3. Preparar herramientas de Google
      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v1'

      # 4. INTELIGENCIA DE COSTOS: Encender la VM si est√° apagada
      - name: Wake up Kinetis Node
        run: |
          echo "üîç Verificando estado de la instancia..."
          STATUS=$(gcloud compute instances describe kinetis-node --zone=us-central1-a --format="value(status)")
          
          if [ "$STATUS" = "TERMINATED" ]; then
            echo "üí§ La instancia est√° durmiendo. Encendiendo para trabajar..."
            gcloud compute instances start kinetis-node --zone=us-central1-a --project=kinetis-security
            echo "‚è≥ Esperando 45 segundos para que el SSH est√© listo..."
            sleep 45
          else
            echo "‚ö° La instancia ya est√° activa. Procediendo..."
          fi

      # 5. DESPLIEGUE PROFESIONAL v√≠a SSH
      - name: Sync & Build on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Detener el script si hay errores
            set -e
            
            echo "üìÇ Preparando directorio de trabajo..."
            mkdir -p ~/kinetis-ai-guard
            cd ~/kinetis-ai-guard
            
            # L√≥gica de Git: Clonar si es nuevo, Pull si ya existe
            if [ ! -d ".git" ]; then
              echo "üöÄ Clonando repositorio por primera vez..."
              git clone https://github.com/marcos1394/kinetis-ai-guard.git .
            else
              echo "üîÑ Actualizando c√≥digo fuente..."
              git pull origin main
            fi
            
            # AQU√ç AGREGAMOS VALOR PROFESIONAL
            # Verificamos si Sui est√° instalado para intentar compilar
            if command -v sui &> /dev/null; then
                echo "üõ†Ô∏è  Sui detectado. Compilando contratos para verificar integridad..."
                cd contracts/kinetis_core
                # sui move build # (Descomenta esto cuando hayamos instalado Sui en la VM)
                echo "‚úÖ Compilaci√≥n exitosa (Simulada por ahora)."
            else
                echo "‚ö†Ô∏è  Sui no est√° instalado en la VM todav√≠a. Solo se actualizaron los archivos."
                echo "‚ÑπÔ∏è  Pr√≥ximo paso: Instalar binarios de Sui en el servidor."
            fi
            
            echo "üéâ Despliegue completado exitosamente."